#!/usr/bin/env bash

set -euo pipefail

current_script_path=${BASH_SOURCE[0]}
plugin_dir=$(dirname "$(dirname "$current_script_path")")

# shellcheck source=./lib/utils.bash
source "${plugin_dir}/lib/utils.bash"

check_install_type_is_version

if [[ "$ASDF_INSTALL_VERSION" == "latest" ]]; then
	echo "The AWFY plugin does not support 'latest' as a version."
	echo "Please specify a supported prefix to latest."
	echo "For example: asdf install awfy latest:graaljs-jvm"
	# it's too unspecific to get the latest version
	# because this plugin supports multiple tools
	exit 1
fi

# determine the download URL based on the version prefix
if [[ "$ASDF_INSTALL_VERSION" == "graaljs-jvm"* ]]; then
	version=${ASDF_INSTALL_VERSION#"graaljs-jvm-"}
	kernel_name=$(uname -s | tr '[:upper:]' '[:lower:]')
	arch=$(uname -m)

	url=$(release_url_graaljs "$version" "$kernel_name" "$arch" "jvm")
elif [[ "$ASDF_INSTALL_VERSION" == "graaljs"* ]]; then
	version=${ASDF_INSTALL_VERSION#"graaljs-"}
	kernel_name=$(uname -s | tr '[:upper:]' '[:lower:]')
	arch=$(uname -m)

	url=$(release_url_graaljs "$version" "$kernel_name" "$arch" "native")
elif [[ "$ASDF_INSTALL_VERSION" == "graalpy-jvm"* ]]; then
	version=${ASDF_INSTALL_VERSION#"graalpy-jvm-"}
	kernel_name=$(uname -s | tr '[:upper:]' '[:lower:]')
	arch=$(uname -m)

	url=$(release_url_graalpy "$version" "$kernel_name" "$arch" "jvm")
fi

download_release "$url" "$ASDF_DOWNLOAD_PATH" "$ASDF_INSTALL_VERSION"
